{"version":3,"file":"index.js","names":["SmoothCollapse","props","React","createRef","el","callback","_removeTransitionEndListener","listener","timeout","clearTimeout","removeEventListener","addEventListener","ms","getTransitionTimeMs","heightTransition","setTimeout","state","renderInner","expanded","_visibleWhenClosed","closing","fullyClosed","height","collapsedHeight","prevProps","prevState","mainEl","_main","current","innerEl","_inner","Error","targetHeight","clientHeight","setState","_onNextTransitionEnd","onChangeEnd","visibleWhenClosed","allowOverflowWhenOpen","children","eagerRender","overflow","display","transition","parseFloat","Component","PropTypes","bool","isRequired","func","string","className"],"sources":["../src/index.js"],"sourcesContent":["/* @flow */\n\nimport * as React from 'react';\nimport PropTypes from 'prop-types';\n\nimport getTransitionTimeMs from './getTransitionTimeMs';\n\nexport type Props = {\n  children?: React.Node;\n  expanded: boolean;\n  onChangeEnd?: ?() => void;\n  collapsedHeight: string;\n  heightTransition: string;\n  className: string;\n  allowOverflowWhenOpen: boolean;\n  eagerRender: boolean;\n};\ntype State = {\n  renderInner: boolean;\n  closing: boolean;\n  fullyClosed: boolean;\n  height: string;\n};\n\nexport default class SmoothCollapse extends React.Component<Props,State> {\n  _removeTransitionEndListener = () => {};\n  _main = React.createRef<HTMLDivElement>();\n  _inner = React.createRef<HTMLDivElement>();\n  static propTypes = {\n    expanded: PropTypes.bool.isRequired,\n    onChangeEnd: PropTypes.func,\n    collapsedHeight: PropTypes.string,\n    heightTransition: PropTypes.string,\n    className: PropTypes.string,\n    allowOverflowWhenOpen: PropTypes.bool,\n    eagerRender: PropTypes.bool\n  };\n  static defaultProps = {\n    collapsedHeight: '0',\n    heightTransition: '.25s ease',\n    className: '',\n    allowOverflowWhenOpen: false,\n    eagerRender: false\n  };\n\n  constructor(props: Props) {\n    super(props);\n    this.state = {\n      renderInner: props.expanded || SmoothCollapse._visibleWhenClosed(props),\n      closing: false,\n      fullyClosed: !props.expanded,\n      height: props.expanded ? 'auto' : props.collapsedHeight\n    };\n  }\n\n  static _visibleWhenClosed(props: Props) {\n    return props.eagerRender || parseFloat(props.collapsedHeight) !== 0;\n  }\n\n  componentWillUnmount() {\n    this._removeTransitionEndListener();\n  }\n\n  static getDerivedStateFromProps(props: Props, state: State) {\n    if (props.expanded && (state.closing || state.fullyClosed)) {\n      return {\n        closing: false,\n        fullyClosed: false,\n        renderInner: true\n      };\n    } else if (!props.expanded && (state.closing || state.fullyClosed) && state.height !== props.collapsedHeight) {\n      return {\n        height: props.collapsedHeight,\n        renderInner: state.renderInner || SmoothCollapse._visibleWhenClosed(props)\n      };\n    }\n    return null;\n  }\n\n  _onNextTransitionEnd = (el: HTMLDivElement, callback: () => void) => {\n    this._removeTransitionEndListener();\n\n    const listener = () => {\n      this._removeTransitionEndListener();\n      callback();\n    };\n\n    let timeout;\n    this._removeTransitionEndListener = () => {\n      this._removeTransitionEndListener = () => {};\n      clearTimeout(timeout);\n      el.removeEventListener('transitionend', listener);\n    };\n\n    // Wait until the transitionend event, or until a timer goes off in\n    // case the event doesn't fire because the browser doesn't support it\n    // or the element is hidden before it happens. The timer is a little\n    // longer than the transition is supposed to take to make sure we don't\n    // cut the animation early while it's still going if the browser is\n    // running it just a little slow.\n    el.addEventListener('transitionend', listener);\n    const ms = getTransitionTimeMs(this.props.heightTransition) * 1.1 + 500;\n    timeout = setTimeout(listener, ms);\n  };\n\n  componentDidUpdate(prevProps: Props, prevState: State) {\n    if (!prevProps.expanded && this.props.expanded) {\n      this._removeTransitionEndListener();\n\n      const mainEl = this._main.current;\n      const innerEl = this._inner.current;\n      if (!mainEl || !innerEl) throw new Error('Should not happen');\n\n      // Set the collapser to the target height instead of auto so that it\n      // animates correctly. Then switch it to 'auto' after the animation so\n      // that it flows correctly if the page is resized.\n      const targetHeight = `${innerEl.clientHeight}px`;\n      this.setState({\n        height: targetHeight\n      });\n\n      this._onNextTransitionEnd(mainEl, () => {\n        this.setState({\n          height: 'auto'\n        }, () => {\n          if (this.props.onChangeEnd) {\n            this.props.onChangeEnd();\n          }\n        });\n      });\n    } else if (prevProps.expanded && !this.props.expanded) {\n      this._removeTransitionEndListener();\n\n      if (!this._inner.current) throw new Error('Should not happen');\n      this.setState({\n        height: `${this._inner.current.clientHeight}px`\n      }, () => {\n        const mainEl = this._main.current;\n        if (!mainEl) throw new Error('Should not happen');\n\n        mainEl.clientHeight; // force the page layout\n        this.setState({\n          height: this.props.collapsedHeight,\n          closing: true\n        });\n\n        this._onNextTransitionEnd(mainEl, () => {\n          this.setState({\n            closing: false,\n            fullyClosed: true\n          });\n          if (this.props.onChangeEnd) {\n            this.props.onChangeEnd();\n          }\n        });\n      });\n    }\n  }\n\n  render() {\n    const visibleWhenClosed = SmoothCollapse._visibleWhenClosed(this.props);\n    const {\n      allowOverflowWhenOpen, children, collapsedHeight, eagerRender, expanded,\n      heightTransition, onChangeEnd, ...props\n    } = this.props;\n    const {height, fullyClosed, renderInner} = this.state;\n    const innerEl = renderInner ?\n      <div ref={this._inner} style={{\n        overflow: allowOverflowWhenOpen && height === 'auto' ? 'visible' : 'hidden'\n      }}>\n        { children }\n      </div>\n      : null;\n\n    return (\n      <div\n        {...props}\n        ref={this._main}\n        style={{\n          height,\n          overflow: allowOverflowWhenOpen && height === 'auto' ? 'visible' : 'hidden',\n          display: (fullyClosed && !visibleWhenClosed) ? 'none': null,\n          transition: `height ${heightTransition}`\n        }}\n      >\n        {innerEl}\n      </div>\n    );\n  }\n}\n"],"mappings":"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"}